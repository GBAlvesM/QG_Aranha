<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles/dashboard.css">
    <link rel="shortcut icon" href="../assets/favicon.png" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Dashboard</title>
</head>

<body>
    <div id="container">
        <div id="boxdash">
            <div id="menu">
                <img src="../assets/logo.png" alt="" class="logo">
                <div class="itens">
                    <a href="inicial.html" style="color: #b42727;">Início</a>
                    <a href="ranking.html">Ranking</a>
                </div>
                <div class="logout">
                    <a href="../quiz.html">Jogar novamente</a>
                    <a href="../index.html">Sair</a>
                </div>
            </div>
            <div id="conteudo">
                <div id="bv">
                    <h1>Olá, <span id="nomeUser"></span>, veja os seus resultados!</h1>
                </div>
                <div id="grafs">
                    <div id="sessao1">
                        <div id="kpis">
                            <div class="cardkpi">
                                <p>Sua última pontuação:</p><span id="ultNota">#</span>
                            </div>
                            <div class="cardkpi">
                                <p>Sua maior pontuação:</p><span id="maiNota">#</span>
                            </div>
                            <div class="cardkpi">
                                <p>Taxa de acertos:</p><span id="txAcerto">#</span>
                            </div>
                        </div>
                        <div id="graficoTentativas">
                            <h3>Suas últimas tentativas</h3>
                            <canvas id="myChart2"></canvas>
                        </div>
                        <div id="graficoMedia">
                            <h3>Sua nota média X nota média da comunidade</h3>
                            <canvas id="myChart3"></canvas>
                        </div>
                    </div>
                    <div id="sessao2">
                        <h2>Qual Homem-Aranha a comunidade prefere?</h2>
                        <div id="graficoPreferencia">
                            <canvas id="myChart1"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    window.onload = dadosPreferencia()

    function dadosPreferencia() {
        document.getElementById("nomeUser").innerHTML = sessionStorage.NOME_USUARIO
        const idUser = sessionStorage.ID_USUARIO

        console.log(idUser)

        fetch("/medidas/preferencias")
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`)

                        let labelsGraf = []
                        let valores = []

                        resposta.forEach(item => {
                            labelsGraf.push(item.preferencia)
                            valores.push(item.Total)
                        })

                        const ctx = document.getElementById("myChart1")

                        new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: [`${labelsGraf[0]}: (${valores[0]})`, `${labelsGraf[1]}: (${valores[1]})`],
                                datasets: [{
                                    label: 'Preferências da comunidade',
                                    data: valores,
                                    borderWidth: 2,
                                    borderColor: '#000000',
                                    backgroundColor: ['#b42727', '#246caf']
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        grid: {
                                            display: false
                                        },
                                        border: {
                                            display: false
                                        },
                                        ticks: {
                                            display: false
                                        }
                                    }
                                },
                                layout: {
                                    padding: 5
                                },
                                plugins: {
                                    legend: {
                                        labels: {
                                            font: {
                                                size: 16,
                                                family: 'avenir'
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                    )
                } else {
                    console.error('Nenhum dado encontrado ou erro na API')
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados para o gráfico ${error.message}`)
            })

        fetch("/medidas/kpis", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idServer: idUser

            }),

        })
            .then(function (responsek) {
                if (responsek.ok) {
                    responsek.json().then(function (kpisResult) {
                        console.log(`Dados recebidos: ${JSON.stringify(kpisResult)}`)

                        var ultimaNota = null
                        var maiorNota = null
                        var taxaAcerto = null
                        var mediaU = null
                        var mediaG = null

                        kpisResult.forEach(item => {
                            ultimaNota = item.Ultima
                            maiorNota = item.Maior
                            taxaAcerto = item.Taxa

                            ultNota.innerHTML = ultimaNota
                            maiNota.innerHTML = maiorNota
                            txAcerto.innerHTML = taxaAcerto
                            mediaU = item.MediaU
                            mediaG = item.MediaG
                        })

                        const ctx3 = document.getElementById("myChart3")

                        new Chart(ctx3, {
                            type: 'bar',
                            data: {
                                labels: ['Notas'],
                                datasets: [{
                                    label: `Sua média: (${mediaU})`,
                                    data: [mediaU],
                                    borderWidth: 2,
                                    borderColor: '#000000',
                                    backgroundColor: ['#246caf', '#b42727'],
                                },
                                {
                                    label: `Média da comunidade: (${mediaG})`,
                                    data: [mediaG],
                                    borderWidth: 2,
                                    borderColor: '#000000',
                                    backgroundColor: ['#b42727'],
                                }],
                            },

                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                indexAxis: 'y',
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                    },
                                    x: {
                                        max: 10
                                    }
                                },
                                layout: {
                                    padding: 18
                                },
                                plugins: {
                                    legend: {
                                        labels: {
                                            display: true,
                                            labels: {
                                                color: 'rgb(255, 99, 132)'
                                            },
                                            font: {
                                                size: 14,
                                                family: 'avenir'
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                    )
                } else {
                    console.error('Nenhum dado encontrado ou erro na API')
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados para o gráfico ${error.message}`)
            })

        fetch("/medidas/tentativas", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idServer: idUser

            }),

        })
            .then(function (responseT) {
                if (responseT.ok) {
                    responseT.json().then(function (grafResult) {
                        console.log(`Dados recebidos: ${JSON.stringify(grafResult)}`)

                        var tentativas = []
                        var pontuacaoTentativa = []

                        grafResult.forEach(item => {
                            tentativas.push(item.Tentativa)
                            pontuacaoTentativa.push(item.pontuacao)

                        })

                        const ctxT = document.getElementById('myChart2');

                        new Chart(ctxT, {
                            type: 'bar',
                            data: {
                                labels: tentativas,
                                datasets: [{
                                    label: 'Pontuação por tentatitva',
                                    data: pontuacaoTentativa,
                                    borderWidth: 2,
                                    borderColor: '#000000',
                                    backgroundColor: '#b42727e6'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                layout: {
                                    padding: 15
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 10
                                    },

                                },
                                plugins: {
                                    legend: {
                                        labels: {
                                            font: {
                                                size: 14,
                                                family: 'avenir'
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                    )
                } else {
                    console.error('Nenhum dado encontrado ou erro na API')
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados para o gráfico ${error.message}`)
            })
    }

</script>

</html>